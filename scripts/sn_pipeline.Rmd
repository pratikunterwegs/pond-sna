---
editor_options: 
  chunk_output_type: console
---

# Build reads data to networks pipeline

```{r}
# load libraries
library(readr)
library(readxl)
library(dplyr)
library(tidyr)
library(lubridate)
library(pondr)

# for plotting
library(ggplot2)
library(patchwork)
```

Read file names in data folder.

```{r}
# get data folders
folders = list.dirs("data", recursive = F)

# list csv files for each system, ie, each folder
files = lapply(folders, function(fl) {
  list.files(fl, pattern = "CSV", full.names = TRUE)  
})

# get node data by reading excel files from each folder
# the read excel function is applied to a flexibly constructed
# file path
fish_data = Map(folders, seq(length(folders)),
                f = function(fl, number) {
  read_excel(
    path = sprintf("%s/Data System %i.xlsx", fl, number)
  )
})
```

```{r}
# read data and rename columns
data = Map(
  files, seq(length(files)),
  f = function(fl, num) {
    lapply(fl, read_delim, delim = ";") |>
      bind_rows() |> 
      mutate(
        system = num
      )
  })

data = lapply(data, function(df) {
  rename(
    df,
    date = Date, time = Time, antenna = `Unit number`,
    id = `Transponder code`
  )
})

# clean the data using a pondr function
data = Map(data, fish_data, f = function(reads, nodes) {
  pondr::pr_clean_data(reads, block_ref_df = nodes)
})

# add system id
data = Map(
  data, seq(length(data)),
  f = function(df, num) {
    df$system = num
    df
  }
)
```

It is very important to clean the data before making networks, as the network construction fails when it finds nodes (fish) in the edge list, that are not in the node list. This happens when there are errors in tag reading, introducing a new tag code into the edgelist that is not among the tags in the node data.

```{r}
# bind columns and split by date
data_nt = bind_rows(data) %>%
  mutate(
    date = date(time)
  ) %>%
  nest_by(
    date, system
  )

# get an example daily network, time bin is 5 seconds by default
networks = lapply(data_nt$data, pr_make_network, 
                  block_ref_df = fish_data, time_bin = "5 minutes")
```

## Getting Zero Weight Interactions

```{r}
# code to get edgelist
edge_list = tidygraph::activate(network, edges) |>
  as_tibble()

# assign a number to each individual
fish_data$num_id = seq(nrow(fish_data))

# attach the fish ids to the edgelist
fd = fish_data |>
  select(id, num_id)

edge_list = left_join(edge_list, fd, by = c("from" = "num_id")) |>
  left_join(fd, by = c("to" = "num_id"))

# add dyad id
edge_list$dyad_id = sprintf("%s-%s", edge_list$id.x, edge_list$id.y)

edge_list = select(
  edge_list, -from, -to
)

# join with theoretical
edge_list = right_join(
  edge_list, unique_pairs, by = "dyad_id"
)

# select useful cols
edge_list = select(edge_list, from, to, dyad_id, weight)

# assign 0 is weight is NA, ie, no interaction
edge_list = mutate(
  edge_list,
  weight = ifelse(test = is.na(weight), yes = 0, no = weight)
)
```

```{r}
# make a custom layout that is fixed between plots
# this must be based on an initial network - choose one
layout = igraph::layout.kamada.kawai(networks[[1]])

# make plots and wrap
nt_plots = Map(
  networks, data_nt$date,
  f = function(n, d) {
    pr_plot_network(
      network = n,
      colour_by = length_mm,
      wt_lim = 150,
      layout = layout
    ) +
      scico::scale_fill_scico(
        palette = "hawaii"
      )+
    labs(
      title = d,
      fill = "Length (mm)"
    )+
    theme(
      legend.position = "top",
      legend.key.height = unit(2, "mm")
    )
  }
)

# wrap all plots
figure = wrap_plots(
  nt_plots,
  guides = "collect"
) &
  theme(
    legend.position = "top"
  )

# save figure
ggsave(
  filename = "figures/fig_show_sn.png"
)
```
